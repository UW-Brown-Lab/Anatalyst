<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Wesley Blashka">
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Creating New Modules - Anatalyst</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Anatalyst</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="nav-item">
                                <a href="../../installation/" class="nav-link">Installation</a>
                            </li>
                            <li class="nav-item">
                                <a href="../../getting-started/" class="nav-link">Getting Started</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Configuration</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../configuration/" class="dropdown-item">Overview</a>
</li>
                                    
<li>
    <a href="../../configuration/examples/" class="dropdown-item">Examples</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Modules</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../modules/" class="dropdown-item">Overview</a>
</li>
                                    
<li>
    <a href="../../modules/dataloading/" class="dropdown-item">DataLoading</a>
</li>
                                    
<li>
    <a href="../../modules/qcmetrics/" class="dropdown-item">QCMetrics</a>
</li>
                                    
<li>
    <a href="../../modules/ambientrnaremoval/" class="dropdown-item">AmbientRNARemoval</a>
</li>
                                    
<li>
    <a href="../../modules/doubletdetection/" class="dropdown-item">DoubletDetection</a>
</li>
                                    
<li>
    <a href="../../modules/filtering/" class="dropdown-item">Filtering</a>
</li>
                                    
<li>
    <a href="../../modules/pearsonnormalization/" class="dropdown-item">PearsonNormalization</a>
</li>
                                    
<li>
    <a href="../../modules/dimensionalityreduction/" class="dropdown-item">DimensionalityReduction</a>
</li>
                                    
<li>
    <a href="../../modules/reportgenerator/" class="dropdown-item">ReportGenerator</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Customization</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../" class="dropdown-item">Overview</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Creating New Modules</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">API Documentation</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../api/" class="dropdown-item">Overview</a>
</li>
                                    
<li>
    <a href="../../api/core/" class="dropdown-item">Core Classes</a>
</li>
                                    
<li>
    <a href="../../api/utils/" class="dropdown-item">Utilities</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Examples</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../examples/" class="dropdown-item">Overview</a>
</li>
                                    
<li>
    <a href="../../examples/pbmc/" class="dropdown-item">PBMC Analysis</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item">
                                <a href="../../about/" class="nav-link">About</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../../api/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/wblashka/edit/master/docs/customization/new-modules.md" class="nav-link">Edit on yourusername/sc_pipeline
                                    </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#creating-custom-modules-for-the-single-cell-pipeline" class="nav-link">Creating Custom Modules for the Single-Cell Pipeline</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#overview" class="nav-link">Overview</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#module-structure" class="nav-link">Module Structure</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#step-by-step-guide" class="nav-link">Step-by-Step Guide</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#module-best-practices" class="nav-link">Module Best Practices</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#using-your-custom-module" class="nav-link">Using Your Custom Module</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#notes" class="nav-link">Notes</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="creating-custom-modules-for-the-single-cell-pipeline">Creating Custom Modules for the Single-Cell Pipeline<a class="headerlink" href="#creating-custom-modules-for-the-single-cell-pipeline" title="Permanent link">&para;</a></h1>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p>Anatalyst is designed to be extensible, allowing you to create custom modules that integrate seamlessly with the existing workflow or create an entirely new workflow. This guide will walk you through the process of creating a new analysis module.</p>
<h2 id="module-structure">Module Structure<a class="headerlink" href="#module-structure" title="Permanent link">&para;</a></h2>
<p>Each module is a Python class that inherits from <code>AnalysisModule</code>. The basic structure includes:</p>
<ul>
<li>Initialization method</li>
<li>Parameter schema</li>
<li><code>run</code> method</li>
<li>Optional helper methods</li>
</ul>
<h2 id="step-by-step-guide">Step-by-Step Guide<a class="headerlink" href="#step-by-step-guide" title="Permanent link">&para;</a></h2>
<h3 id="1-create-the-module-file">1. Create the Module File<a class="headerlink" href="#1-create-the-module-file" title="Permanent link">&para;</a></h3>
<p>Create a new file in <code>sc_pipeline/modules/</code> with a descriptive name, e.g., <code>myanalysis.py</code>.</p>
<h3 id="2-import-required-modules">2. Import Required Modules<a class="headerlink" href="#2-import-required-modules" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># At a minimum</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sc_pipeline.core.module</span><span class="w"> </span><span class="kn">import</span> <span class="n">AnalysisModule</span>
</code></pre></div>

<h3 id="3-define-the-module-class">3. Define the Module Class<a class="headerlink" href="#3-define-the-module-class" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MyAnalysis</span><span class="p">(</span><span class="n">AnalysisModule</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description of your custom module&#39;s purpose.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Define the parameter schema</span>
    <span class="n">PARAMETER_SCHEMA</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;param1&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>  <span class="c1"># Parameter type</span>
            <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># Whether the parameter is mandatory</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Description of the parameter&#39;</span>
        <span class="p">},</span>
        <span class="s1">&#39;optional_param&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>  <span class="c1"># Default value if not provided</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;An optional parameter&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="c1"># Call the parent class constructor</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

        <span class="c1"># Set up logging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Module.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Define required inputs and outputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">required_inputs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>  <span class="c1"># Inputs this module needs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>  <span class="c1"># Outputs this module will produce</span>
</code></pre></div>

<h3 id="4-implement-the-run-method">4. Implement the <code>run</code> Method<a class="headerlink" href="#4-implement-the-run-method" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_context</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main method to execute the module&#39;s analysis.</span>

<span class="sd">    Args:</span>
<span class="sd">        data_context: Shared data context containing pipeline data</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True if successful, False otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Retrieve the AnnData object</span>
        <span class="n">adata</span> <span class="o">=</span> <span class="n">data_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>

        <span class="c1"># Access module parameters</span>
        <span class="n">param1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;param1&#39;</span><span class="p">)</span>
        <span class="n">optional_param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;optional_param&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

        <span class="c1"># Perform your analysis</span>
        <span class="c1"># Example: Do something with the data</span>

        <span class="c1"># Optional: Create visualization</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;create_plots&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_plots</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">data_context</span><span class="p">)</span>

        <span class="c1"># Update the data context</span>
        <span class="n">data_context</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">adata</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in analysis: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>

<h3 id="5-add-optional-visualization-method">5. Add Optional Visualization Method<a class="headerlink" href="#5-add-optional-visualization-method" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_create_plots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adata</span><span class="p">,</span> <span class="n">data_context</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create and save visualization figures.</span>

<span class="sd">    Args:</span>
<span class="sd">        adata: AnnData object</span>
<span class="sd">        data_context: Shared data context</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Create a matplotlib figure</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

        <span class="c1"># Create your plot</span>
        <span class="c1"># sc.pl.something(adata, ax=ax)</span>

        <span class="c1"># Save the figure using the parent class method</span>
        <span class="n">img_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_figure</span><span class="p">(</span><span class="n">data_context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fig</span><span class="p">)</span>

        <span class="c1"># Add figure to the report</span>
        <span class="n">data_context</span><span class="o">.</span><span class="n">add_figure</span><span class="p">(</span>
            <span class="n">module_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;My Analysis Plot&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Description of the plot&quot;</span><span class="p">,</span>
            <span class="n">image_path</span><span class="o">=</span><span class="n">img_path</span>
        <span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating plots: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h2 id="module-best-practices">Module Best Practices<a class="headerlink" href="#module-best-practices" title="Permanent link">&para;</a></h2>
<ul>
<li>Use logging for tracking module progress and errors</li>
<li>Handle exceptions gracefully</li>
<li>Provide clear documentation and parameter descriptions</li>
<li>Create visualizations when possible</li>
<li>Minimize data transformation, preferring to add information to the AnnData object</li>
</ul>
<h2 id="using-your-custom-module">Using Your Custom Module<a class="headerlink" href="#using-your-custom-module" title="Permanent link">&para;</a></h2>
<p>To use your new module in a pipeline configuration:</p>
<div class="codehilite"><pre><span></span><code><span class="nt">modules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my_custom_analysis</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MyAnalysis</span>
<span class="w">    </span><span class="nt">params</span><span class="p">:</span>
<span class="w">      </span><span class="nt">param1</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;example_value&quot;</span>
<span class="w">      </span><span class="nt">optional_param</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20</span>
</code></pre></div>

<h2 id="notes">Notes<a class="headerlink" href="#notes" title="Permanent link">&para;</a></h2>
<ul>
<li>Modules should be idempotent (can be run multiple times without side effects)</li>
<li>Prefer adding information to AnnData's <code>.obs</code>, <code>.var</code>, <code>.uns</code>, or as layers</li>
<li>Keep modules focused on a single type of analysis</li>
</ul></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-mml-chtml.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
